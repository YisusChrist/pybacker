#!/usr/bin/env python3

"""
@file     pybacker
@date     2023-01-05
@version  0.0.3
@license  GNU General Public License v2.0
@url      https://github.com/YisusChrist/pybacker
@author   Alejandro Gonzalez Momblan
"""

import os
import subprocess
import sys
import time
from tkinter import Tk, filedialog

EXIT_SUCCESS = 0
EXIT_FAILURE = 1


def check_dir_list(dirs: list) -> bool:
    """
    Check if a list of directories exist

    Args:
        dirs (list): List of directories to check

    Returns:
        bool: True if all directories exist, False otherwise

    Notes:
        This function is used to check if a list of directories exist
        before copying files to the backup directory
    """

    for dir in dirs:
        if not os.path.exists(dir):
            print(f"Directory '{dir}' does not exist")
            return False

    return True


def run_cmd(cmd) -> str:
    """
    Run a command and return the output

    Args:
        cmd (str): Command to run

    Returns:
        str: Output of the command

    Raises:
        CalledProcessError: If the command returns a non-zero exit status

    Notes:
        This function is used to run commands in the terminal
        and return the output of the command

        This function is used to run commands that are not
        available in the Python standard library or that require
        the use of the shell

        For example, the "cp" command is not available in the
        Python standard library and requires the use of the shell
        to copy directories and files, so it is necessary to use this
        function to run the command
    """
    try:
        output = subprocess.check_output(cmd, shell=True)
    except subprocess.CalledProcessError:
        output = ""
    return output.decode("utf-8").strip()


def create_empty(backup_dir: str, files: list) -> None:
    """
    Create empty containers for the files to be backed up

    Args:
        backup_dir (str): Directory where the backup will be stored
        files (list): List of files to create empty containers for

    Notes:
        This function is used to create empty directories and files
        so that the files can be copied to the backup directory
        without having to create the directories and files manually

        This function is also useful for files that are created by the user
        but are not created by the user

        For example, if the user has a file in the directory
        "/home/omega/.local/share/pswm/pswm.db"
        and the directory "/home/omega/.local/share/pswm" does not exist
        then the file cannot be copied to the backup directory
        because the directory does not exist
    """
    for file in files:
        try:
            file_path = "/".join(file.split("/")[:-1])
        except IndexError:
            file_path = ""

        file_path = backup_dir + file_path

        # Make the directory if it doesn't exist
        os.makedirs(file_path, exist_ok=True)


def get_file_list() -> list:
    """
    Get the list of files to be backed up from a file

    Returns:
        list: List of files to be backed up
    """
    print("Select the file with the list to be backed up")
    # Create a Tk root window
    root = Tk()
    # Hide the main window
    root.withdraw()
    # Ask the user to select a file
    file_path = filedialog.askopenfilename()
    if not file_path:
        print("No file selected.")
        sys.exit(EXIT_FAILURE)

    file_name = file_path.split("/")[-1]
    print(f"Reading file '{file_name}'...")

    with open(file_path, "r") as f:
        files = [
            line.strip()
            for line in f.readlines()
            if not line.startswith("#") and line.strip()
        ]

    return files


def main() -> int:
    try:
        backup_dir = str(sys.argv[1]) + f"/backup_{round(time.time())}"
    except IndexError:
        backup_dir = os.getcwd() + f"/backup_{round(time.time())}"

    files = get_file_list()

    print("Checking directories...")
    if not check_dir_list(files):
        print("Some directories do not exist")
        print("Exiting...")
        sys.exit(EXIT_FAILURE)

    print("All directories exist")

    print("Creating backup directory...")
    os.mkdir(backup_dir)

    print("Creating empty containers...")
    create_empty(backup_dir)

    print("Backing up files...")
    for file in files:
        cmd = f"cp -r '{file}' '{backup_dir}{file}'"
        out = run_cmd(cmd)

        if out:
            print("--------------------------------")
            print(f"COMMAND: {cmd}")
            print(f"RETURNED: {out}")
            print("--------------------------------")

    print("Checking backup directory...")
    bak_files = [str(backup_dir + file) for file in files]

    if not check_dir_list(bak_files):
        print("Some directories could not be backed up")
        print("Exiting...")
        sys.exit(EXIT_FAILURE)

    sys.exit(EXIT_SUCCESS)


if __name__ == "__main__":
    main()
